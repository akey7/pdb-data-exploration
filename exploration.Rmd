---
title: "Exploration of PDB Metadata"
author: "Alicia Key"
date: "`r Sys.Date()`"
output: html_document
---

# Exploration of PDB Metadata

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Include libraries and set plot theme.

### Libraries

```{r error=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
```

### Theme set

```{r}
theme_set(theme_minimal())
```

## Load the dataset

```{r}
pdb <- read_csv("data/pdb_data_no_dups.csv")
```

### Look at the head of the dataset

```{r}
head(pdb)
```

## Missing data

When I looked at the .csv in Excel, I found lots of missing data in the dataset. In this section, I quantify how much missing data there is.

### Bar graph of missing value counts

```{r}
pdb_total_rows = nrow(pdb)

pdb_missing <- pdb %>%
  summarize(
    structureIdNa = sum(is.na(structureId)) / pdb_total_rows * 100,
    classificationNa = sum(is.na(classification)) / pdb_total_rows * 100,
    experimentalTechniqueNa = sum(is.na(experimentalTechnique)) / pdb_total_rows * 100,
    macromoleculeTypeNa = sum(is.na(macromoleculeType)) / pdb_total_rows * 100,
    residueCountNa = sum(is.na(residueCount)) / pdb_total_rows * 100,
    resolutionNa = sum(is.na(resolution)) / pdb_total_rows * 100,
    structureMolecularWeightNa = sum(is.na(structureMolecularWeight)) / pdb_total_rows * 100,
    crystallizationMethodNa = sum(is.na(crystallizationMethod)) / pdb_total_rows * 100,
    crystallizationTempK = sum(is.na(crystallizationTempK)) / pdb_total_rows * 100,
    densityMatthewsNa = sum(is.na(densityMatthews)) / pdb_total_rows * 100,
    densityPercentSolNa = sum(is.na(densityPercentSol)) / pdb_total_rows * 100,
    pdbxDetailsNa = sum(is.na(pdbxDetails)) / pdb_total_rows * 100,
    phValueNa = sum(is.na(phValue)) / pdb_total_rows * 100,
    publicationYearNa = sum(is.na(publicationYear)) / pdb_total_rows * 100
  ) %>%
  pivot_longer(everything(), names_to = "column", values_to = "percent_missing") %>%
  arrange(percent_missing)

pdb_missing %>%
  mutate(
    column_sort = factor(
      column,
      levels = pdb_missing$column
    )
  ) %>%
  ggplot(aes(x = column_sort, y = percent_missing)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "Percent missing per column",
      subtitle = "Higher is worse"
    )
```

### What if I dropped all `NA`?

Percentage observations remaining if all rows that have `NA` were dropped:

```{r}
pdb_no_na_count <- pdb %>%
  drop_na() %>%
  nrow()

pdb_no_na_count / pdb_total_rows * 100
```

Number of observations remaining if all the `NA`s were dropped.

```{r}
pdb_total_rows - pdb_no_na_count
```

### Plan of action: drop rows with `NA` and filter year range

For this exploration, I will simply drop all rows that have any `NA` variables. I will also restrict the year range to [2000, 2018)

```{r}
pdb_clean <- pdb %>%
  drop_na() %>%
  filter(publicationYear >= 2000, publicationYear < 2018)
```

## Exploratory Visualization and Analysis

### Publications per year

```{r}
pdb_clean %>%
  group_by(publicationYear) %>%
  summarize(publicationCount = n()) %>%
  ggplot(aes(x = publicationYear, y = publicationCount)) +
    geom_line() +
    labs(
      title = "Publication count versus year"
    ) +
    xlab("year") +
    ylab("publication count")
```

### Macromolecule type by year

As time progressed, what different types of macromolecules were published? In other words, did technology progress and allow more types of macromolecules to be analyzed?

```{r}
pdb_clean %>%
  group_by(publicationYear, macromoleculeType) %>%
  summarize(publicationCount = n()) %>%
  ggplot(aes(x = publicationYear, y = publicationCount)) +
    geom_line() +
    facet_wrap(~ macromoleculeType, scales = "free_y")
```

Some of these facets are really spikey! I wonder if that is because of all the rows I dropped earlier.

### Molecular weight by experimental technique

```{r}
ggplot(pdb_clean, aes(x = experimentalTechnique, y = structureMolecularWeight)) +
  geom_boxplot() +
  scale_y_log10() +
  coord_flip() +
  labs(
    title = "Molecular weight by experimental technique"
  ) +
  ylab("log(molecular weight)") +
  xlab("experimental technique")
```

### Resolution by experimental technique

```{r}
ggplot(pdb_clean, aes(x = experimentalTechnique, y = resolution)) +
  geom_boxplot() +
  coord_flip() +
  labs(
    title = "Resolution by experimental technique"
  ) +
  ylab("resolution (angstroms)") +
  xlab("experimental technique")
```

## Conclusion

In the future, it would be interesting to:

- Train a model on the sequence data that accompanies this dataset, to see if I could fill in missing values based on sequence data.

- Find if there were any systematic features missing for each `macromoleculeType`. Maybe each macro molecule should get its own schema of attributes that are likely to be filled in.

- Mine the text of `pdbxDetails`.

- Mine the text of `crystallizationMethod`.
